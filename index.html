<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TBC Networks Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }

    /* Map title */
    .map-title {
      font: 40px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 700;
      color: #111;
      text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .leaflet-interactive { cursor: pointer; }
    .tip { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .tip .label { color:#666; }
    .tip-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; color: #111; }
    .poly-label {
      background: transparent; border: 0; box-shadow: none;
      color: #1f2937; font: 13px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      text-align: center; white-space: nowrap;
      text-shadow: 0 1px 2px rgba(255,255,255,.85), 0 0 2px rgba(255,255,255,.9);
      pointer-events: none; line-height: 1.15;
    }
    .leaflet-tooltip.hover-tip {
      background: #fff; color: #111; border: 1px solid #e5e7eb;
      border-radius: 10px; box-shadow: 0 4px 14px rgba(0,0,0,.12);
      padding: 8px 10px;
    }
    .leaflet-tooltip.hover-tip:before { display: none; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 8px; }
    .gallery a { display:block; border-radius:8px; overflow:hidden; box-shadow: 0 1px 4px rgba(0,0,0,.12); }
    .gallery img { display:block; width:100%; height:100%; object-fit: cover; aspect-ratio: 4 / 3; }
    hr { border:0; border-top:1px solid #e9ecef; margin:8px 0; }
    .leaflet-control-layers .basemap-heading,
    .leaflet-control-layers .overlays-heading { font-weight: 600; margin-bottom: 4px; display: block; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-providers@1.13.0/leaflet-providers.js"></script>
  <script>
    const map = L.map('map', { center: [37.8, -122.3], zoom: 9, preferCanvas: true });

    // --- Add map title control ---
    const titleDiv = L.DomUtil.create('div', 'map-title');
    titleDiv.innerHTML = "TBC Networks";
    document.querySelector('#map').appendChild(titleDiv);
    titleDiv.style.position = "absolute";
    titleDiv.style.top = "10px";
    titleDiv.style.left = "50%";
    titleDiv.style.transform = "translateX(-50%)";
    titleDiv.style.zIndex = 1000;

    // ------------------------------
    // Basemaps (all 15, grouped for easy commenting)
    // ------------------------------
    const baseMaps = {
      // --- Minimal & Light ---
      "Carto Light (Positron)":   L.tileLayer.provider('CartoDB.Positron'),
      "Esri World Gray Canvas":  L.tileLayer.provider('Esri.WorldGrayCanvas'),
      "Stamen Toner Lite":       L.tileLayer.provider('Stamen.TonerLite'),

      // --- Medium Contrast / General Reference ---
      "OpenStreetMap Standard":  L.tileLayer.provider('OpenStreetMap.Mapnik'),
      "Carto Voyager":           L.tileLayer.provider('CartoDB.Voyager'),
      "Esri World Street Map":   L.tileLayer.provider('Esri.WorldStreetMap'),
      "OpenTopoMap":             L.tileLayer.provider('OpenTopoMap'),

      // --- Dark / Contrast Options ---
      "Carto Dark Matter":       L.tileLayer.provider('CartoDB.DarkMatter'),
      "Stamen Toner (Dark B/W)": L.tileLayer.provider('Stamen.Toner'),

      // --- Satellite / Aerial ---
      "Esri World Imagery":      L.tileLayer.provider('Esri.WorldImagery'),
      "USGS US Topo":            L.tileLayer.provider('USGS.USTopo'),

      // --- Hybrid / Specialty ---
      "Esri NatGeo World Map":   L.tileLayer.provider('Esri.NatGeoWorldMap'),
      "Stamen Watercolor":       L.tileLayer.provider('Stamen.Watercolor'),

      "Hike & Bike":             L.tileLayer.provider('HikeBike.HikeBike'),
      "Wikimedia":               L.tileLayer.provider('Wikimedia')
    };

    // Set default basemap
    baseMaps["Esri World Gray Canvas"].addTo(map);

    // ------------------------------
    // Overlay layers (Networks & Counties)
    // ------------------------------
    const networksLayer = L.layerGroup().addTo(map);
    const countiesLayer = L.layerGroup().addTo(map);

    // Fetch Networks GeoJSON
    fetch("https://tbc-networks.onrender.com/networks.geojson")
      .then(r => r.json())
      .then(data => {
        const colors = [...Array(30).keys()].map(i => `hsl(${(i*12)%360},70%,60%)`);
        let colorIndex = 0;

        L.geoJSON(data, {
          style: () => ({
            color: colors[colorIndex++ % colors.length],
            weight: 2, fillOpacity: 0.5
          }),
          onEachFeature: (feature, layer) => {
            const props = feature.properties;
            let labelName = props.name.replace(/Network/i, "").trim().split(" ").join("<br/>");

            // Permanent label
            layer.bindTooltip(labelName, {
              permanent: true, direction: "center", className: "poly-label"
            });

            // Tooltip content
            let html = `<div class="tip">
              <div class="tip-name">${props.name}</div>
              <div class="label"><b>Leaders:</b> ${props.leaders}</div>
              <div class="label"><b>Email:</b> <a href="mailto:${props.contact_email}">${props.contact_email}</a></div>
            </div>`;

            // Add photos if any
            const photos = [];
            for (let i = 1; i <= 6; i++) {
              if (props[`photo${i}`]) {
                photos.push(`<a href="${props[`photo${i}`]}" target="_blank"><img src="${props[`photo${i}`]}"/></a>`);
              }
            }
            if (photos.length) {
              html += `<hr/><div class="gallery">${photos.join("")}</div>`;
            }

            layer.bindPopup(html);
            layer.bindTooltip(html, { sticky: true, className: "hover-tip" });
          }
        }).addTo(networksLayer);
      });

    // Fetch Counties GeoJSON
    fetch("https://pastorplt.github.io/tbc_map/tbc_counties.geojson")
      .then(r => r.json())
      .then(data => {
        L.geoJSON(data, {
          style: {
            color: "#999", weight: 1, fillColor: "#ffffcc", fillOpacity: 0.3
          }
        }).addTo(countiesLayer);
      });

    // ------------------------------
    // Layer control with headings
    // ------------------------------
    const layerControl = L.control.layers(baseMaps, {
      "Networks": networksLayer,
      "Counties": countiesLayer
    }, { collapsed: false }).addTo(map);

    // Add section headings to control
    const controlEl = layerControl.getContainer();
    const baseMapsList = controlEl.querySelector(".leaflet-control-layers-base");
    const overlaysList = controlEl.querySelector(".leaflet-control-layers-overlays");

    if (baseMapsList) {
      const heading = document.createElement("div");
      heading.className = "basemap-heading";
      heading.innerText = "Basemap";
      baseMapsList.prepend(heading);
    }
    if (overlaysList) {
      const heading = document.createElement("div");
      heading.className = "overlays-heading";
      heading.innerText = "Layers";
      overlaysList.prepend(heading);
    }
  </script>
</body>
</html>
